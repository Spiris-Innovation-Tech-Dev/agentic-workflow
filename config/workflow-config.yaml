# Agentic Workflow Configuration
# See: ~/.claude/plans/declarative-doodling-unicorn.md for full documentation
#
# Configuration Cascade (each level overrides the previous):
#   1. Global defaults:  ~/.claude/workflow-config.yaml (this file)
#   2. Project config:   <repo>/.claude/workflow-config.yaml
#   3. Task config:      <repo>/.tasks/TASK_XXX/config.yaml
#   4. Command args:     /workflow --loop-mode --max-iterations 50
#
# This allows different repos and tasks to have different settings

# Checkpoint configuration - when to pause for human approval
checkpoints:
  planning:
    after_architect: true      # Review architectural concerns before detailed planning
    after_developer: false     # Auto-proceed to reviewer (plan needs validation first)
    after_reviewer: true       # Review gaps found before skeptic
    after_skeptic: true        # Review edge cases before implementation

  implementation:
    at_25_percent: false       # Auto-proceed through early stages
    at_50_percent: true        # Halfway review - critical checkpoint
    at_75_percent: false       # Auto-proceed to completion
    before_commit: true        # Always review before committing

  documentation:
    after_technical_writer: true  # Review documentation updates before applying

  feedback:
    on_deviation: true         # Ask when implementation deviates from plan
    on_test_failure: true      # Ask when tests fail unexpectedly
    on_major_change: true      # Ask when scope seems to be creeping

# Knowledge base location (relative to project root)
knowledge_base: docs/ai-context/

# Task file location (relative to project root)
task_directory: .tasks/

# Maximum iterations per phase before escalating to human
max_iterations:
  planning: 3                  # Architect → Developer → Reviewer → Skeptic cycles
  implementation: 5            # Retries per major step
  feedback: 2                  # Adjustment attempts before suggesting restart

# Agent model configuration (all opus for maximum quality)
# Note: Research agents (architect, developer, reviewer, skeptic) receive Gemini-analyzed context
# Implementation agents (implementer, feedback) receive focused file context
models:
  orchestrator: opus
  architect: opus              # Receives Gemini analysis via ARCHITECTURAL_CONTEXT section
  developer: opus              # Receives Gemini analysis via IMPLEMENTATION_PATTERNS section
  reviewer: opus               # Receives Gemini analysis via REVIEW_CHECKLIST section
  skeptic: opus                # Receives Gemini analysis via FAILURE_MODES section
  implementer: opus            # Receives focused files from current implementation step
  feedback: opus               # Receives focused files for comparison
  technical-writer: opus       # Documents findings and validates ai-context docs

# Subagent Limits
# Prevents runaway discovery loops where agents spawn subagents that loop for hours
# The reported issue: Opus 4.6 aggressively spawns Task subagents for exploration
# that a direct Grep/Glob/Read would answer in seconds
subagent_limits:
  # Max API round-trips (turns) per spawned agent
  max_turns:
    planning_agents: 30            # Architect, Developer, Reviewer, Skeptic
    implementation_agents: 50      # Implementer (needs more turns for multi-step work)
    documentation_agents: 20       # Technical Writer
    consultation_agents: 15        # /crew ask single-agent consultations

  # Agents should prefer direct tools over spawning sub-subagents
  prefer_direct_tools: true        # Include tool discipline guidance in agent prompts

  # Timeout for any single agent run (seconds)
  agent_timeout: 300               # 5 minutes — escalate if exceeded

# Auto-actions (what agents can do without asking)
auto_actions:
  run_tests: true              # Agents can run tests automatically
  create_files: true           # Agents can create new files
  modify_files: true           # Agents can modify existing files
  run_build: true              # Agents can run build commands
  git_add: false               # Require approval for staging
  git_commit: false            # Require approval for commits
  git_push: false              # Require approval for pushing

# Repomix integration
repomix:
  enabled: true
  config_path: repomix.config.json
  auto_refresh: true           # Re-run repomix when files change significantly

# Gemini Research Integration
# Leverages Gemini's massive context window for research phases
# One Gemini analysis feeds focused context to all research agents
gemini_research:
  enabled: true                     # Master switch for Gemini-enhanced research
  fallback_to_opus: true            # Use Opus with direct context if Gemini unavailable
  prefer_native_context: true       # Skip Gemini if repomix output fits in Opus 4.6's 1M context
  native_context_threshold_kb: 800  # Max repomix output size (KB) to pass directly to Opus

  # Research agents receive Gemini-analyzed context
  research_agents:
    - architect
    - developer
    - reviewer
    - skeptic

  # Implementation agents receive focused file context (no Gemini analysis needed)
  implementation_agents:
    - implementer
    - feedback

  # Documentation agents receive implementation context and existing docs
  documentation_agents:
    - technical-writer

  # Context gathering settings (uses repomix-build pattern)
  context_gathering:
    include_base_classes: true      # Find and include base classes/interfaces
    include_referenced: true        # Include files referenced by task-relevant code
    include_examples: true          # Find similar patterns/examples in codebase
    include_docs: true              # Include README, docs/, ai-context/
    max_files: 200                  # Limit to prevent context explosion

  # Gemini analysis prompt (comprehensive, produces sections for each agent)
  analysis_prompt: |
    Analyze this codebase for the following task. Provide separate sections:

    ## ARCHITECTURAL_CONTEXT
    - System boundaries and module relationships
    - Data flow patterns
    - Existing architectural patterns
    - Integration points for the task
    - Security patterns in use
    - Dependency implications

    ## IMPLEMENTATION_PATTERNS
    - Code conventions and patterns used
    - File organization and naming conventions
    - Error handling patterns
    - Testing patterns and conventions
    - Similar implementations to use as reference
    - Import/export patterns

    ## REVIEW_CHECKLIST
    - Patterns to verify against
    - Security requirements that must be followed
    - Testing conventions to maintain
    - Common pitfalls in this codebase
    - Areas of technical debt to avoid
    - Consistency checks needed

    ## FAILURE_MODES
    - Error handling gaps
    - Race condition patterns
    - External dependency failure modes
    - Data validation patterns
    - Recovery/rollback patterns
    - Edge cases to consider

    ## DOCUMENTATION_CONTEXT
    - Base classes and their abstract methods
    - Inheritance hierarchies and responsibilities
    - Framework usage patterns and conventions
    - Key interfaces and their contracts
    - Patterns that would be non-obvious to AI agents
    - Configuration and initialization requirements

    Task: {task_description}

  # Error handling and fallback behavior
  error_handling:
    repomix_unavailable: fallback   # fallback | warn | fail
    gemini_unavailable: fallback    # fallback | warn | fail
    gemini_timeout: 120             # Seconds before timing out Gemini analysis

# Loop Mode (Ralph Wiggum-style autonomous iteration)
# When enabled, agents loop until completion instead of stopping after one attempt
loop_mode:
  enabled: false                    # Master toggle - override per-task with --loop-mode

  # Which phases use loop mode
  phases:
    planning: false                 # Usually false - planning needs human judgment
    implementation: true            # Loop until tests/build pass
    documentation: false            # Usually false - docs are one-shot

  # Completion signals - agents output these when done
  completion_promise: "COMPLETE"    # e.g., <promise>COMPLETE</promise>
  blocked_promise: "BLOCKED"        # e.g., <promise>BLOCKED: reason</promise>

  # Iteration limits
  max_iterations:
    per_step: 10                    # Max attempts per implementation step
    per_phase: 30                   # Max total iterations per phase
    before_escalate: 5              # After N iterations, pause for human check

  # Verification method - what "success" means
  verification:
    method: tests                   # tests | build | lint | custom | all
    custom_command: ""              # Used when method is "custom"
    require_all_pass: true          # For "all": must pass tests AND build AND lint

  # Self-correction behavior
  self_correction:
    enabled: true                   # Allow agent to analyze failures and retry
    max_same_error: 3               # After N identical errors, try different approach
    read_full_output: true          # Force agent to read complete error output

  # Escalation triggers
  escalation:
    on_repeated_failure: true       # Same error 3x = escalate to human
    on_scope_creep: true            # Detected deviation from plan = escalate
    on_security_concern: true       # Security-related changes = escalate

# Beads Integration (optional)
# Link workflow tasks to beads issues for persistent tracking
beads:
  enabled: auto                     # auto = enable if beads is installed, true/false to force
  auto_create_issue: false          # Create beads issue when starting workflow
  auto_link: true                   # Link task to existing issue if mentioned
  sync_status: true                 # Update beads issue status as workflow progresses
  add_comments: true                # Add workflow progress as beads comments

# Model Resilience Configuration
# Handles API failures with exponential backoff and automatic failover
resilience:
  enabled: true                     # Master switch for resilience features

  # Retry configuration
  retry:
    max_attempts: 3                 # Max retries before failing over
    backoff_seconds: [60, 300, 1500]  # Exponential backoff: 1m, 5m, 25m

  # Fallback chain - models tried in order when primary fails
  fallback_chain:
    - model: claude-opus-4-6
      timeout: 120                  # Seconds before timeout
    - model: claude-opus-4
      timeout: 120
    - model: claude-sonnet-4
      timeout: 60
    - model: gemini
      timeout: 60

  # Cooldown durations by error type
  cooldown:
    rate_limit_seconds: 60          # 429 errors - start with 1 minute
    overloaded_seconds: 60          # 529 errors - API overloaded
    error_seconds: 300              # General errors - 5 minutes
    billing_seconds: 18000          # Billing/quota issues - 5 hours
    max_cooldown_seconds: 3600      # Cap for exponential backoff - 1 hour

  # Automatic recovery
  recovery:
    reset_on_success: true          # Reset consecutive errors after success
    clear_cooldown_on_success: true # Clear cooldown immediately on success

# Context Management
# Tools for managing context pressure during long workflows
context_management:
  # Thresholds for recommendations
  thresholds:
    low_percent: 30                 # Below this: no action needed
    moderate_percent: 60            # Above this: consider saving discoveries
    high_percent: 80                # Above this: recommend pruning
    critical_percent: 95            # Above this: prune aggressively

  # Auto-pruning settings
  auto_prune:
    enabled: false                  # Auto-prune when context is high
    trigger_percent: 80             # Trigger auto-prune at this threshold
    keep_last_n: 5                  # Keep N most recent prunable files

  # Files safe to prune (large verbose outputs)
  prunable_patterns:
    - "repomix-output.txt"
    - "gemini-analysis.md"
    - "*.log"

  # Files that should never be pruned
  preserve_patterns:
    - "state.json"
    - "plan.md"
    - "config.yaml"
    - "task.md"
    - "architect.md"
    - "developer.md"
    - "reviewer.md"
    - "skeptic.md"

# Server-Side Compaction (Anthropic API beta)
# Auto-summarizes conversation when approaching context limits
compaction:
  enabled: true
  model: "compact-2026-01-12"        # Compaction model
  trigger_tokens: 80000              # Min tokens before compaction triggers
  pause_after_compaction: true       # Pause to inject workflow state after compaction
  instructions: |
    Preserve: current task ID, workflow phase, implementation progress,
    active concerns, file paths being modified, test status.
    Discard: verbose tool outputs, intermediate search results,
    full file contents already processed.

# Cross-Task Memory
# Enable learning from previous tasks
memory:
  enabled: true
  # Discovery categories
  categories:
    - decision                      # Architectural/planning decisions
    - pattern                       # Code patterns discovered
    - gotcha                        # Edge cases, quirks, non-obvious things
    - blocker                       # Issues that blocked progress
    - preference                    # User/project preferences

  # Cross-task search
  search:
    max_results: 20                 # Default max search results
    include_completed_tasks: true   # Search completed tasks too

  # Task linking
  relationships:
    - related                       # General relationship
    - builds_on                     # This task extends another
    - supersedes                    # This task replaces another
    - blocked_by                    # This task depends on another

# Workflow Modes
# Different modes skip agents for faster execution on simpler tasks
workflow_modes:
  # Default mode when --mode not specified
  default: auto

  # Mode definitions - which phases are included
  modes:
    full:
      description: "All 7 agents - complex features, critical changes"
      phases:
        - architect
        - developer
        - reviewer
        - skeptic
        - implementer
        - feedback
        - technical_writer
      estimated_cost: "$0.50+"

    turbo:
      description: "Developer plans comprehensively in one pass - standard features with Opus 4.6"
      phases:
        - developer
        - implementer
        - technical_writer
      estimated_cost: "$0.15"

    fast:
      description: "Skip Skeptic and Feedback - standard changes"
      phases:
        - architect
        - developer
        - reviewer
        - implementer
        - technical_writer
      estimated_cost: "$0.25"

    minimal:
      description: "Developer, Implementer, and Technical Writer - simple fixes, typos"
      phases:
        - developer
        - implementer
        - technical_writer
      estimated_cost: "$0.10"

  # Auto-detection rules for determining mode
  auto_detection:
    minimal:
      # Any of these trigger minimal mode
      keywords:
        - typo
        - fix typo
        - simple fix
        - rename
        - update comment
        - fix import
      max_files_affected: 1
      no_tests_required: true

    turbo:
      # Opus 4.6 single-pass planning for standard work
      keywords:
        - add feature
        - implement
        - update
        - refactor
        - add
        - create
        - build
        - utility
      no_security_changes: true
      no_database_changes: true
      no_api_changes: true

    fast:
      # Use fast mode for these patterns
      keywords:
        - add feature
        - implement
        - update
        - refactor
      single_module: true
      no_security_changes: true
      no_database_changes: true

    full:
      # Always use full mode for these
      keywords:
        - security
        - authentication
        - authorization
        - database
        - migration
        - api
        - breaking change
        - critical
      multiple_systems: true
      requires_review: true

# Effort Levels (maps to Anthropic API parameters)
# When calling Messages API:
#   thinking: {"type": "adaptive"}   — Claude decides thinking depth
#   output_config: {"effort": "<level>"}  — from table below
# Values: low | medium | high | max (max is Opus 4.6 only)
effort_levels:
  full:
    architect: max
    developer: max
    reviewer: high
    skeptic: max
    implementer: high
    feedback: high
    technical_writer: medium
  turbo:
    developer: max
    implementer: high
    technical_writer: medium
  fast:
    architect: high
    developer: high
    reviewer: high
    implementer: high
    technical_writer: medium
  minimal:
    developer: medium
    implementer: medium
    technical_writer: medium

# Parallelization Configuration
parallelization:
  # Run Reviewer and Skeptic in parallel
  reviewer_skeptic:
    enabled: true
    timeout_seconds: 300
    merge_strategy: deduplicate     # deduplicate | combine | prioritize_reviewer

# Agent Teams (experimental — Claude Code agent teams feature)
# Enables real multi-agent collaboration via CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS
# Requires: Claude Code with agent teams support
agent_teams:
  enabled: false                      # Set to true to use real agent teams

  # Parallel review — Reviewer and Skeptic as real teammates
  parallel_review:
    enabled: false
    delegate_mode: true               # Lead agent coordinates only, doesn't execute
    plan_approval: true               # Require plan approval before execution

  # Parallel implementation — implementation steps as self-claimed tasks
  parallel_implementation:
    enabled: false
    max_concurrent_agents: 3          # Max parallel implementers
    require_independent_steps: true   # Only parallelize independent steps

# Cost Tracking
cost_tracking:
  enabled: true
  # Model costs per million tokens (approximate)
  model_costs:
    opus:
      input_per_million: 5.00
      output_per_million: 25.00
    opus_long_context:
      input_per_million: 10.00
      output_per_million: 37.50
    sonnet:
      input_per_million: 3.00
      output_per_million: 15.00
    haiku:
      input_per_million: 0.80
      output_per_million: 4.00
  # Show cost summary at workflow completion
  show_summary: true
  # Store cost history
  store_history: true

# Specialized Agents (optional, auto-triggered)
specialized_agents:
  security_auditor:
    enabled: auto                   # auto | true | false
    triggers:
      keywords:
        - auth
        - password
        - token
        - secret
        - SQL
        - encryption
        - credential
        - permission
        - session
        - cookie
      file_patterns:
        - "**/auth/**"
        - "**/security/**"
        - "**/.env*"
        - "**/secrets/**"
    checkpoint_after: true
    position: after_reviewer        # Run after reviewer, parallel with skeptic

  performance_analyst:
    enabled: auto
    triggers:
      keywords:
        - performance
        - cache
        - optimize
        - slow
        - scale
        - n+1
        - query
      file_patterns:
        - "**/database/**"
        - "**/query/**"
        - "**/cache/**"
    checkpoint_after: false
    position: after_reviewer

  api_guardian:
    enabled: auto
    triggers:
      keywords:
        - API
        - endpoint
        - breaking
        - deprecate
        - contract
        - schema
        - openapi
        - swagger
      file_patterns:
        - "**/api/**"
        - "**/routes/**"
        - "**/schemas/**"
        - "**/openapi*"
    checkpoint_after: true
    position: after_developer

  accessibility_reviewer:
    enabled: auto
    triggers:
      keywords:
        - UI
        - component
        - form
        - a11y
        - accessibility
        - WCAG
        - aria
      file_patterns:
        - "**/*.tsx"
        - "**/*.jsx"
        - "**/*.vue"
        - "**/*.html"
    checkpoint_after: false
    position: after_reviewer

# Quality Assertions
quality:
  assertions:
    enabled: true
    # Assertion types available
    types:
      - file_exists
      - test_passes
      - no_pattern
      - contains_pattern
      - type_check_passes
      - lint_passes
    # Fail workflow on assertion failure
    fail_on_assertion_failure: true
    # Auto-verify assertions after each implementation step
    auto_verify: true

# Error Pattern Learning
error_patterns:
  enabled: true
  storage_file: ".error_patterns.jsonl"
  # Auto-match errors to known solutions
  auto_match: true
  # Minimum confidence for suggesting a solution
  min_confidence: 0.7
  # Record new patterns automatically
  auto_record: true

# Agent Performance Tracking
agent_performance:
  enabled: true
  # Track concern outcomes
  track_outcomes: true
  # Calculate precision over this many days
  time_range_days: 30
  # Categories to track
  categories:
    - race_condition
    - missing_validation
    - security
    - performance
    - error_handling
    - edge_case

# Git Worktree Support
# Enables parallel /crew workflows in isolated worktrees
worktree:
  base_path: "../{repo_name}-worktrees"
  branch_prefix: "crew/"
  cleanup_on_complete: prompt  # prompt | auto | never
  auto_launch: prompt          # prompt | auto | never
  ai_host: auto                # auto | claude | gemini | copilot
  copy_settings: true            # Copy host CLI settings (e.g., .claude/settings.local.json) to worktree
